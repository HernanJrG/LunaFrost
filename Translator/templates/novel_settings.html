{% extends "base.html" %}

{% block title %}
{% if chapter_index is not none %}
{{ chapter.get('translated_title', chapter.title) }} - Chapter Settings
{% else %}
{{ get_display_title(novel) }} - Novel Settings
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <header>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            {% if chapter_index is not none %}
            <a href="/chapter/{{ novel_id }}/{{ chapter_index }}" class="btn btn-primary">‚Üê Back to Chapter</a>
            {% else %}
            <a href="/novel/{{ novel_id }}" class="btn btn-primary">‚Üê Back to Novel</a>
            {% endif %}
            <button id="open-values-btn" class="btn btn-secondary" style="padding: 10px 18px;">Translation Cost</button>
            {% if novel.get('novel_source_url') %}
            <a href="{{ novel.novel_source_url }}" target="_blank" class="btn btn-secondary">üîó View on Novelpia</a>
            {% endif %}
        </div>
        {% if chapter_index is not none %}
        <h1>{{ chapter.get('translated_title', chapter.title) }}</h1>
        <p class="subtitle">Chapter Settings</p>
        {% else %}
        <h1>{{ get_display_title(novel) }}</h1>
        <p class="subtitle">Novel Settings</p>
        {% endif %}
    </header>

    <div id="alert-container"></div>

    {% if chapter_index is not none %}
    <div class="settings-card">
        <h2>üóëÔ∏è Chapter Management</h2>
        <p style="color: #718096; margin-bottom: 15px;">
            Delete Chapter {{ chapter_index + 1 }}:
            <strong>{{ chapter.get('translated_title', chapter.title) }}</strong>
            {% if chapter.get('translated_title') and chapter.get('translated_title') != chapter.title %}
            <br><em style="font-size: 0.9rem; color: #a0aec0;">ÏõêÏ†ú: {{ chapter.title }}</em>
            {% endif %}
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/chapter/{{ novel_id }}/{{ chapter_index }}?edit=true" class="btn btn-warning"
                style="padding: 12px 24px;">
                ‚úèÔ∏è Edit Chapter Content
            </a>
            <button id="delete-chapter-btn" class="btn btn-danger" style="padding: 12px 24px;"
                data-delete-type="chapter">
                üóëÔ∏è Delete This Chapter
            </button>
        </div>
    </div>
    {% endif %}

    {% if chapter_index is none %}
    <div class="settings-card">
        <h2>üì• Export Novel</h2>
        <p style="color: #718096; margin-bottom: 15px;">
            Download the entire novel as PDF or EPUB.
        </p>
        <a href="/api/export/{{ novel_id }}/pdf" class="btn btn-export" download>üìÑ Download as PDF</a>
        <a href="/api/export/{{ novel_id }}/epub" class="btn btn-export" download>üìñ Download as EPUB</a>
    </div>
    {% endif %}

    {% if show_delete_novel %}
    <div class="settings-card">
        <h2>‚ö†Ô∏è Danger Zone</h2>
        <div class="alert alert-warning" style="margin-bottom: 15px;">
            <strong>Warning:</strong> Deleting this novel will permanently remove all chapters, translations, and
            character glossary. This action cannot be undone.
        </div>
        <button id="delete-novel-btn" class="btn btn-danger" style="padding: 12px 24px;" data-delete-type="novel">
            üóëÔ∏è Delete Entire Novel
        </button>
    </div>
    {% endif %}

    <div class="settings-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>üìù Character Glossary</h2>
        </div>

        <div class="button-group">
            <button id="add-character-btn" class="btn btn-success">‚ûï Add Character Manually</button>
            <button id="auto-detect-btn" class="btn btn-warning">ü§ñ Auto-Detect Characters</button>
        </div>

        <div class="alert alert-info">
            üí° <strong>Tip:</strong> Use "Auto-Detect Characters" to let the AI find character names in your chapters
            automatically and translate them to English. Click on any character to expand and edit details.
        </div>

        <div id="characters-container">
            {% if glossary %}
            {% for char_id, char_info in glossary.items() %}
            <div class="character-entry collapsed" data-char-id="{{ char_id }}">
                <div class="character-header">
                    <div class="character-summary">
                        <span class="korean-name">{{ char_info.get('korean_name', '') }}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="english-name">{{ char_info.get('english_name', '(Not set)') }}</span>
                        {% if char_info.get('gender') %}
                        <span class="gender-badge gender-{{ char_info.get('gender') }}">{{ char_info.get('gender')
                            }}</span>
                        {% else %}
                        <span class="gender-badge gender-none">not set</span>
                        {% endif %}
                    </div>
                    <div class="character-actions">
                        <button class="btn btn-danger btn-remove-char">‚úï</button>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>
                <div class="character-details">
                    <div class="form-group">
                        <label>Korean Name (Original)</label>
                        <input type="text" class="char-korean" placeholder="e.g., ÍπÄÏ≤†Ïàò"
                            value="{{ char_info.get('korean_name', '')|e }}">
                    </div>

                    <div class="form-group">
                        <label>English Name (Translation)</label>
                        <input type="text" class="char-english" placeholder="e.g., John Kim"
                            value="{{ char_info.get('english_name', '')|e }}">
                    </div>

                    <div class="form-group">
                        <label>Gender</label>
                        <select class="char-gender">
                            <option value="">Not specified</option>
                            <option value="male" {% if char_info.get('gender')=='male' %}selected{% endif %}>Male
                                (he/him)</option>
                            <option value="female" {% if char_info.get('gender')=='female' %}selected{% endif %}>Female
                                (she/her)</option>
                            <option value="other" {% if char_info.get('gender')=='other' %}selected{% endif %}>Other
                                (they/them)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Character Notes</label>
                        <textarea class="char-description"
                            placeholder="e.g., Main protagonist, skilled swordsman, age 25">{{ char_info.get('description', '') }}</textarea>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p id="empty-message" style="text-align: center; color: #718096; padding: 40px;">
                No characters added yet. Click "Add Character Manually" or "Auto-Detect Characters" to get started.
            </p>
            {% endif %}
        </div>
    </div>

    <div style="text-align: center;">
        <button id="save-settings-btn" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 40px;">
            üíæ Save Character Glossary
        </button>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <h2 style="color: #2d3748; margin-bottom: 10px;">ü§ñ Auto-Detecting Characters...</h2>
        <p style="color: #718096;">Analyzing chapters and translating names...</p>
        <div class="spinner"></div>
    </div>
</div>

<!-- Values Modal -->
<div id="values-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:640px;">
        <h3>Model Pricing Values (USD per 1,000 tokens)</h3>
        <div id="translation-estimate"
            style="margin-top:6px; padding:8px; background:#f7fafc; border-radius:6px; display:none;">
            <div id="est-counts" style="font-weight:600; color:#2d3748;"></div>
            <div id="est-cost" style="color:#2c5282; margin-top:6px;"></div>
        </div>
        <div id="values-list" style="margin-top:10px; max-height:320px; overflow:auto;"></div>
        <div style="margin-top:12px; display:flex; gap:8px;">
            <button id="add-value-row" class="btn btn-secondary">‚ûï Add Row</button>
            <button id="save-values-btn" class="btn btn-primary">üíæ Save</button>
            <button id="close-values-btn" class="btn btn-link">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script id="novel-settings-data" type="application/json">
{
    "novelId": {{ novel_id|tojson }},
    "chapterIndex": {{ chapter_index|tojson }},
    "glossaryLength": {{ glossary|length }},
    "chapterText": {{ chapter.korean_text|tojson if chapter_index is not none else '""' }},
    "totalChapters": {{ novel.chapters|length }}
}
</script>
<script>
    // Load data from JSON script tag
    window.novelSettingsData = JSON.parse(document.getElementById('novel-settings-data').textContent);
</script>
<script src="{{ url_for('static', filename='js/novel_settings.js') }}"></script>

<script>
    (function () {
        let deleteInProgress = false;

        function handleDeleteClick(e) {
            e.preventDefault();
            e.stopPropagation();

            // Prevent double clicks
            if (deleteInProgress) return;
            deleteInProgress = true;

            let deleteType = e.target.dataset.deleteType;
            let confirmMessage = '';

            // Check if this is the last chapter
            if (deleteType === 'chapter' && window.novelSettingsData.totalChapters === 1) {
                confirmMessage = '‚ö†Ô∏è This is the last chapter in the novel.\n\nDeleting it will also delete the entire novel, including all translations and character glossary.\n\nAre you sure you want to proceed?';

                if (!confirm(confirmMessage)) {
                    deleteInProgress = false;
                    return;
                }

                // Switch to novel deletion
                deleteType = 'novel';
                performDelete(deleteType);
            } else {
                if (deleteType === 'chapter') {
                    confirmMessage = 'Are you sure you want to delete this chapter? This action cannot be undone.';
                } else if (deleteType === 'novel') {
                    confirmMessage = 'Are you sure you want to delete this entire novel?\n\nThis will permanently remove all chapters, translations, and character glossary.\n\nThis action cannot be undone!';
                }

                // Only ask once
                if (!confirm(confirmMessage)) {
                    deleteInProgress = false;
                    return;
                }

                performDelete(deleteType);
            }
        }

        async function performDelete(deleteType) {
            try {
                let endpoint = '';
                let payload = {};

                if (deleteType === 'chapter') {
                    endpoint = '/api/delete-chapter';
                    payload = {
                        novel_id: window.novelSettingsData.novelId,
                        chapter_index: window.novelSettingsData.chapterIndex
                    };
                } else if (deleteType === 'novel') {
                    endpoint = '/api/delete-novel';
                    payload = {
                        novel_id: window.novelSettingsData.novelId
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    if (deleteType === 'chapter') {
                        showAlert('‚úì Chapter deleted successfully! Redirecting...', 'success');
                        setTimeout(function () {
                            window.location.href = '/novel/' + encodeURIComponent(window.novelSettingsData.novelId);
                        }, 1500);
                    } else {
                        showAlert('‚úì Novel deleted successfully! Redirecting...', 'success');
                        setTimeout(function () {
                            window.location.href = '/';
                        }, 1500);
                    }
                } else {
                    showAlert('‚ùå Error: ' + data.error, 'error');
                    deleteInProgress = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå An error occurred while deleting.', 'error');
                deleteInProgress = false;
            }
        }

        // Attach event listeners
        const deleteChapterBtn = document.getElementById('delete-chapter-btn');
        const deleteNovelBtn = document.getElementById('delete-novel-btn');

        if (deleteChapterBtn) {
            deleteChapterBtn.addEventListener('click', handleDeleteClick);
        }

        if (deleteNovelBtn) {
            deleteNovelBtn.addEventListener('click', handleDeleteClick);
        }
    })();

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
        alertDiv.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
    }
</script>
<script>
    // Values modal handler for settings page
    (function () {
        function escapeHtml(s) { if (!s) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

        function createValueRow(modelName = '', inputPer1k = '', outputPer1k = '') {
            const row = document.createElement('div');
            row.className = 'value-row';
            row.style.display = 'flex'; row.style.gap = '8px'; row.style.alignItems = 'center'; row.style.marginBottom = '8px';
            row.innerHTML = `
            <input class="value-model" placeholder="Model name (e.g. openai/gpt-4)" style="flex:2; padding:6px;" value="${escapeHtml(modelName)}" />
            <input class="value-input" placeholder="Input $/1k" style="flex:1; padding:6px;" value="${escapeHtml(inputPer1k)}" />
            <input class="value-output" placeholder="Output $/1k" style="flex:1; padding:6px;" value="${escapeHtml(outputPer1k)}" />
            <button class="remove-value-row btn btn-secondary" title="Remove" style="padding:6px 8px;">‚úñ</button>
        `;
            row.querySelector('.remove-value-row').addEventListener('click', () => row.remove());
            return row;
        }

        async function fetchPricing() {
            try {
                const resp = await fetch('/api/pricing');
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.success && data.pricing) return data.pricing;
                    // If endpoint returns combined pricing with suggested key
                    if (data.success) return data.pricing || {};
                }
            } catch (e) { /* ignore */ }
            try { const raw = localStorage.getItem('lf_model_pricing'); return raw ? JSON.parse(raw) : {}; } catch (e) { return {}; }
        }

        function openModal() { document.getElementById('values-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('values-modal').style.display = 'none'; }

        async function render() {
            const list = document.getElementById('values-list'); if (!list) return;
            list.innerHTML = '';
            const pricing = await fetchPricing();

            // Merge suggested if present
            if (pricing && pricing.suggested) {
                const suggested = pricing.suggested;
                Object.keys(suggested).forEach(m => { if (!pricing[m]) pricing[m] = suggested[m]; });
                // keep suggested under pricing.suggested for reference
            }

            // If we're on a chapter page, render a simple model -> estimated cost list
            if (window.novelSettingsData && window.novelSettingsData.chapterIndex !== null) {
                // Small helper to detect 'thinking' style models
                function isThinkingModelName(name) { if (!name) return false; const n = String(name).toLowerCase(); return n.includes('o1-') || n.includes('thinking') || n.includes('r1') || (n.includes('flash') && n.includes('lite')); }

                // Load provider models from settings so we present the user's configured models
                let providerModels = {};
                try {
                    const resp = await fetch('/api/settings');
                    if (resp.ok) {
                        const s = await resp.json();
                        providerModels = s.get ? s.get('provider_models') : (s.provider_models || {});
                    }
                } catch (e) { /* ignore */ }

                // Fall back: if providerModels empty, use keys from pricing object
                const modelKeys = [];
                if (providerModels && Object.keys(providerModels).length > 0) {
                    Object.values(providerModels).forEach(v => { if (v && modelKeys.indexOf(v) === -1) modelKeys.push(v); });
                }
                if (modelKeys.length === 0) {
                    // Use pricing keys (ignore 'suggested' key)
                    Object.keys(pricing || {}).forEach(k => { if (k !== 'suggested' && modelKeys.indexOf(k) === -1) modelKeys.push(k); });
                }

                // If still empty, show a message and an editable row
                if (modelKeys.length === 0) {
                    list.appendChild(createValueRow('default', '0', '0'));
                    return;
                }

                // For each model, request a silent estimation (use thinking flag heuristics)
                const rows = document.createElement('div');
                rows.style.display = 'flex'; rows.style.flexDirection = 'column'; rows.style.gap = '8px';

                for (const modelName of modelKeys) {
                    const row = document.createElement('div');
                    row.className = 'model-cost-row';
                    row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center'; row.style.padding = '8px'; row.style.borderBottom = '1px solid #eee';
                    const left = document.createElement('div'); left.style.fontWeight = '600'; left.textContent = modelName;
                    const right = document.createElement('div'); right.style.color = '#2c5282'; right.textContent = 'Estimating...';
                    row.appendChild(left); row.appendChild(right);
                    rows.appendChild(row);

                    // Determine thinking mode flag by heuristic
                    const thinking = isThinkingModelName(modelName);

                    // Call estimate endpoint for this chapter text with the appropriate flag
                    (async function (mn, outElem, thinkingFlag) {
                        try {
                            const resp = await fetch('/api/translate/estimate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ text: window.novelSettingsData.chapterText || '', novel_id: window.novelSettingsData.novelId, images: [], use_thinking_mode: thinkingFlag, model: mn })
                            });
                            const data = await resp.json();
                            let costText = 'No pricing available';
                            if (data && data.success && data.estimation) {
                                // Try API-provided cost_info first
                                let costInfo = data.cost_info || null;
                                if ((!costInfo || !costInfo.pricing_available) && pricing) {
                                    // Compute using pricing object if available
                                    const mp = (pricing[mn] || pricing['default'] || {});
                                    const inPer1k = parseFloat(mp.input_per_1k) || 0;
                                    const outPer1k = parseFloat(mp.output_per_1k) || 0;
                                    const input = data.estimation.input_tokens || 0;
                                    const output = data.estimation.output_tokens || 0;
                                    if (inPer1k > 0 || outPer1k > 0) {
                                        const cost = (input / 1000.0) * inPer1k + (output / 1000.0) * outPer1k;
                                        costInfo = { pricing_available: true, total_cost: cost };
                                    }
                                }

                                if (costInfo && costInfo.pricing_available && costInfo.total_cost !== null) {
                                    costText = `Est. ${formatCost(costInfo.total_cost)}`;
                                } else {
                                    costText = 'Pricing unavailable ‚Äî enter values in Settings';
                                }
                            } else {
                                costText = 'Estimation failed';
                            }
                            outElem.textContent = costText;
                        } catch (e) { outElem.textContent = 'Error estimating'; }
                    })(modelName, right, thinking);
                }

                list.appendChild(rows);
                return;
            }

            // Default: settings page behavior (editable values list)
            try {
                const keys = Object.keys(pricing);
                if (keys.length === 0) list.appendChild(createValueRow('default', '0', '0'));
                keys.forEach(m => {
                    if (m === 'suggested') return;
                    const p = pricing[m] || {};
                    list.appendChild(createValueRow(m, p.input_per_1k || '', p.output_per_1k || ''));
                });
            } catch (e) { console.warn('Render values list failed', e); }
        }

        document.getElementById('open-values-btn')?.addEventListener('click', async () => { await render(); openModal(); });
        document.getElementById('close-values-btn')?.addEventListener('click', closeModal);
        document.getElementById('add-value-row')?.addEventListener('click', () => {
            const list = document.getElementById('values-list'); if (list) list.appendChild(createValueRow('', '', ''));
        });

        document.getElementById('save-values-btn')?.addEventListener('click', async () => {
            const rows = Array.from(document.querySelectorAll('#values-list .value-row'));
            const obj = {};
            rows.forEach(r => {
                const model = r.querySelector('.value-model')?.value.trim();
                const input = r.querySelector('.value-input')?.value.trim();
                const output = r.querySelector('.value-output')?.value.trim();
                if (model) { obj[model] = { input_per_1k: input || '0', output_per_1k: output || '0' }; }
            });

            try {
                await fetch('/api/pricing', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(obj) });
            } catch (e) { console.warn('Failed to save pricing to server', e); }
            try { localStorage.setItem('lf_model_pricing', JSON.stringify(obj)); } catch (e) { }

            closeModal();
            showAlert('Values saved', 'success');
        });

    })();
</script>
{% endblock %}