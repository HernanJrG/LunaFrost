{% extends "base.html" %}

{% block title %}Token Usage - LunaFrost Translator{% endblock %}

{% block content %}
<div class="container">
    <header>
        <div style="margin-bottom: 20px;">
            <a href="/" class="btn btn-primary">‚Üê Back to Novels</a>
        </div>
        <h1>üìä Token Usage Dashboard</h1>
        <button id="values-btn" class="btn btn-secondary" style="margin-left:12px;">Values</button>
        <p style="color: #718096; margin-top: 10px;">
            Track your translation token usage and estimated costs. 
            <span id="pricing-status" style="font-size: 0.9rem; color: #2c5282; font-weight: 500;"></span>
        </p>
    </header>

    <div id="loading" style="text-align: center; padding: 40px;">
        <p>Loading token usage data...</p>
    </div>

    <div id="dashboard-content" style="display: none;">
        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card" style="background: #e6f3ff; padding: 20px; border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; color: #2d3748;">All Time</h3>
                <div style="font-size: 2rem; font-weight: bold; color: #2c5282;" id="all-time-tokens">-</div>
                <div style="color: #718096; font-size: 0.9rem; margin-top: 5px;">
                    <span id="all-time-input">-</span> input / <span id="all-time-output">-</span> output
                </div>
            </div>
            <div class="stat-card" style="background: #fff5e6; padding: 20px; border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; color: #2d3748;">This Month</h3>
                <div style="font-size: 2rem; font-weight: bold; color: #c05621;" id="month-tokens">-</div>
                <div style="color: #718096; font-size: 0.9rem; margin-top: 5px;">
                    <span id="month-input">-</span> input / <span id="month-output">-</span> output
                </div>
            </div>
            <div class="stat-card" style="background: #f0fff4; padding: 20px; border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; color: #2d3748;">This Week</h3>
                <div style="font-size: 2rem; font-weight: bold; color: #22543d;" id="week-tokens">-</div>
                <div style="color: #718096; font-size: 0.9rem; margin-top: 5px;">
                    <span id="week-input">-</span> input / <span id="week-output">-</span> output
                </div>
            </div>
        </div>

        <!-- Breakdown Sections -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- By Provider -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin-top: 0;">By Provider</h2>
                <div id="provider-breakdown">
                    <p style="color: #718096;">Loading...</p>
                </div>
            </div>

            <!-- By Model -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="margin-top: 0;">By Model</h2>
                <div id="model-breakdown">
                    <p style="color: #718096;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Daily Usage Chart -->
        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <h2 style="margin-top: 0;">Daily Usage (Last 30 Days)</h2>
            <div id="daily-chart" style="min-height: 200px;">
                <p style="color: #718096;">Loading chart data...</p>
            </div>
        </div>

        <!-- Help Section -->
        <div style="background: #e6f3ff; padding: 20px; border-radius: 8px; margin-top: 30px;">
            <h3 style="margin-top: 0;">‚ÑπÔ∏è How to Calculate Costs</h3>
            <p>Token counts are provided so you can calculate costs using your provider's current pricing:</p>
            <ul>
                <li><strong>OpenRouter:</strong> Check <a href="https://openrouter.ai/models" target="_blank">openrouter.ai/models</a> for current pricing</li>
                <li><strong>OpenAI:</strong> Check <a href="https://platform.openai.com/pricing" target="_blank">platform.openai.com/pricing</a> for current pricing</li>
                <li><strong>Google Gemini:</strong> Check <a href="https://ai.google.dev/pricing" target="_blank">ai.google.dev/pricing</a> for current pricing</li>
            </ul>
            <p style="margin-bottom: 0;"><strong>Formula:</strong> Cost = (Input Tokens / 1,000,000 √ó Input Price) + (Output Tokens / 1,000,000 √ó Output Price)</p>
        </div>
    </div>
</div>

<!-- Values Modal (shared UI for entering per-model pricing) -->
<div id="values-modal" class="values-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
    <div style="background:white; max-width:720px; width:90%; border-radius:8px; padding:16px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">Model Pricing Values</h3>
            <button id="close-values-modal" class="close-btn">&times;</button>
        </div>
        <p style="color:#718096;">Enter per-model prices in <strong>USD per 1,000 tokens</strong> (input/output). Add models you use and set input/output prices separately.</p>

        <div id="values-list" style="max-height:360px; overflow:auto; margin-top:8px;">
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
            <button id="add-value-row" class="btn btn-secondary">+ Add Model</button>
            <button id="save-values-btn" class="btn btn-primary">Save</button>
            <button id="cancel-values-btn" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    async function loadTokenUsageStats() {
        try {
            const response = await fetch('/api/token-usage/stats');
            const data = await response.json();

            if (data.success && data.stats) {
                const stats = data.stats;
                
                // Update pricing status
                const pricingStatus = document.getElementById('pricing-status');
                if (stats.model_costs && Object.values(stats.model_costs).some(c => c && c.pricing_available)) {
                    pricingStatus.textContent = '‚úì Automatic pricing available for OpenRouter models';
                    pricingStatus.style.color = '#22543d';
                } else {
                    pricingStatus.textContent = 'Cost estimates shown where pricing data is available';
                    pricingStatus.style.color = '#718096';
                }

                function formatCost(cost) {
                    if (cost === null || cost === undefined) return null;
                    if (cost < 0.01) return `$${cost.toFixed(4)}`;
                    if (cost < 1) return `$${cost.toFixed(3)}`;
                    return `$${cost.toFixed(2)}`;
                }

                // Update summary cards
                if (stats.all_time) {
                    document.getElementById('all-time-tokens').textContent = formatNumber(stats.all_time.total_tokens);
                    document.getElementById('all-time-input').textContent = formatNumber(stats.all_time.total_input_tokens);
                    document.getElementById('all-time-output').textContent = formatNumber(stats.all_time.total_output_tokens);
                }

                if (stats.this_month) {
                    document.getElementById('month-tokens').textContent = formatNumber(stats.this_month.total_tokens);
                    document.getElementById('month-input').textContent = formatNumber(stats.this_month.total_input_tokens);
                    document.getElementById('month-output').textContent = formatNumber(stats.this_month.total_output_tokens);
                }

                if (stats.this_week) {
                    document.getElementById('week-tokens').textContent = formatNumber(stats.this_week.total_tokens);
                    document.getElementById('week-input').textContent = formatNumber(stats.this_week.total_input_tokens);
                    document.getElementById('week-output').textContent = formatNumber(stats.this_week.total_output_tokens);
                }

                // Update provider breakdown
                if (stats.by_provider) {
                    const providerDiv = document.getElementById('provider-breakdown');
                    providerDiv.innerHTML = '';
                    
                    const providers = Object.entries(stats.by_provider).sort((a, b) => b[1].total_tokens - a[1].total_tokens);
                    
                    if (providers.length === 0) {
                        providerDiv.innerHTML = '<p style="color: #718096;">No data available</p>';
                    } else {
                        providers.forEach(([provider, data]) => {
                            const div = document.createElement('div');
                            div.style.marginBottom = '15px';
                            div.innerHTML = `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${provider.charAt(0).toUpperCase() + provider.slice(1)}</strong>
                                    <span>${formatNumber(data.total_tokens)} tokens</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #718096;">
                                    ${formatNumber(data.input_tokens)} input / ${formatNumber(data.output_tokens)} output
                                    (${data.count} translations)
                                </div>
                            `;
                            providerDiv.appendChild(div);
                        });
                    }
                }

                // Update model breakdown
                if (stats.by_model) {
                    const modelDiv = document.getElementById('model-breakdown');
                    modelDiv.innerHTML = '';
                    
                    const models = Object.entries(stats.by_model).sort((a, b) => b[1].total_tokens - a[1].total_tokens);
                    const modelCosts = stats.model_costs || {};
                    
                    if (models.length === 0) {
                        modelDiv.innerHTML = '<p style="color: #718096;">No data available</p>';
                    } else {
                        // helper to get local pricing
                        function getLocalPricing(model) {
                            try {
                                const raw = localStorage.getItem('lf_model_pricing');
                                if (!raw) return null;
                                const obj = JSON.parse(raw);
                                return obj[model] || obj['default'] || null;
                            } catch (e) { return null; }
                        }

                        models.slice(0, 10).forEach(([model, data]) => {
                            const div = document.createElement('div');
                            div.style.marginBottom = '15px';
                            
                            let costText = '';
                            const costInfo = modelCosts[model];
                            if (costInfo && costInfo.pricing_available && costInfo.total_cost !== null) {
                                const cost = formatCost(costInfo.total_cost);
                                if (cost) {
                                    costText = `<div style="font-size: 0.85rem; color: #2c5282; font-weight: 500; margin-top: 3px;">Estimated Cost: ${cost}</div>`;
                                }
                            } else {
                                // Try local pricing
                                const local = getLocalPricing(model);
                                if (local) {
                                    const inputPrice = parseFloat(local.input_per_1k) || 0;
                                    const outputPrice = parseFloat(local.output_per_1k) || 0;
                                    const inputCost = (data.input_tokens / 1000.0) * inputPrice;
                                    const outputCost = (data.output_tokens / 1000.0) * outputPrice;
                                    const totalCost = inputCost + outputCost;
                                    costText = `<div style="font-size: 0.85rem; color: #2c5282; font-weight: 500; margin-top: 3px;">Estimated Cost: ${formatCost(totalCost)}</div>`;
                                }
                            }
                            
                            div.innerHTML = `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong style="font-size: 0.9rem;">${model}</strong>
                                    <span>${formatNumber(data.total_tokens)} tokens</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #718096;">
                                    ${formatNumber(data.input_tokens)} input / ${formatNumber(data.output_tokens)} output
                                    (${data.count} translations)
                                </div>
                                ${costText}
                            `;
                            modelDiv.appendChild(div);
                        });
                        if (models.length > 10) {
                            const moreDiv = document.createElement('div');
                            moreDiv.style.color = '#718096';
                            moreDiv.style.fontSize = '0.85rem';
                            moreDiv.textContent = `... and ${models.length - 10} more models`;
                            modelDiv.appendChild(moreDiv);
                        }
                    }
                }

                // Update daily chart
                if (stats.recent_daily) {
                    const chartDiv = document.getElementById('daily-chart');
                    chartDiv.innerHTML = '';
                    
                    const days = Object.entries(stats.recent_daily).sort((a, b) => a[0].localeCompare(b[0]));
                    
                    if (days.length === 0) {
                        chartDiv.innerHTML = '<p style="color: #718096;">No data available</p>';
                    } else {
                        const maxTokens = Math.max(...days.map(([_, data]) => data.total_tokens));
                        
                        days.forEach(([date, data]) => {
                            const bar = document.createElement('div');
                            bar.style.marginBottom = '10px';
                            const percentage = maxTokens > 0 ? (data.total_tokens / maxTokens) * 100 : 0;
                            bar.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 80px; font-size: 0.85rem; color: #718096;">${new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                    <div style="flex: 1; background: #e2e8f0; border-radius: 4px; height: 24px; position: relative;">
                                        <div style="background: #4299e1; height: 100%; width: ${percentage}%; border-radius: 4px; transition: width 0.3s;"></div>
                                        <div style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); font-size: 0.85rem; color: #2d3748; font-weight: 500;">
                                            ${formatNumber(data.total_tokens)} tokens
                                        </div>
                                    </div>
                                </div>
                            `;
                            chartDiv.appendChild(bar);
                        });
                    }
                }

                // Show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
            } else {
                document.getElementById('loading').innerHTML = '<p style="color: #e53e3e;">Error loading token usage data</p>';
            }
        } catch (error) {
            console.error('Error loading token usage:', error);
            document.getElementById('loading').innerHTML = '<p style="color: #e53e3e;">Error loading token usage data</p>';
        }
    }

    // Load data when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTokenUsageStats);
    } else {
        loadTokenUsageStats();
    }
</script>
<script>
    // Values modal helpers (similar behavior as chapter page)
    function createValueRow(modelName = '', inputPer1k = '', outputPer1k = '') {
        const row = document.createElement('div');
        row.className = 'value-row';
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.alignItems = 'center';
        row.style.marginBottom = '8px';

        row.innerHTML = `
            <input class="value-model" placeholder="Model name (e.g. openai/gpt-4)" style="flex:2; padding:6px;" value="${modelName}" />
            <input class="value-input" placeholder="Input $/1k" style="flex:1; padding:6px;" value="${inputPer1k}" />
            <input class="value-output" placeholder="Output $/1k" style="flex:1; padding:6px;" value="${outputPer1k}" />
            <button class="remove-value-row btn btn-secondary" title="Remove" style="padding:6px 8px;">‚úñ</button>
        `;

        row.querySelector('.remove-value-row').addEventListener('click', () => row.remove());
        return row;
    }

    function openValuesModal() {
        (async function () {
            const list = document.getElementById('values-list');
            if (!list) return;
            list.innerHTML = '';

            // Fetch server-side pricing and settings (fallback to localStorage)
            let pricing = {};
            try {
                const resp = await fetch('/api/pricing');
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.success && data.pricing) pricing = data.pricing;
                }
            } catch (e) {
                // ignore
            }

            try {
                const raw = localStorage.getItem('lf_model_pricing');
                const local = raw ? JSON.parse(raw) : {};
                // Merge: prefer server pricing but fill from local where missing
                pricing = Object.assign({}, local, pricing);
            } catch (e) {
                console.warn('Error reading local pricing', e);
            }

            // If server suggested OpenRouter pricing was returned under .suggested, merge into top-level
            try {
                if (pricing && pricing.suggested) {
                    const suggested = pricing.suggested;
                    Object.keys(suggested).forEach(m => {
                        if (!pricing[m]) pricing[m] = suggested[m];
                    });
                    delete pricing.suggested;
                }
            } catch (e) {
                console.warn('Error merging suggested pricing', e);
            }

            // Also fetch available models from settings to pre-populate useful rows
            try {
                const sresp = await fetch('/api/settings');
                if (sresp.ok) {
                    const sdata = await sresp.json();
                    const avail = sdata.available_models || sdata.settings && sdata.settings.available_models || {};
                    // Flatten providers' models
                    Object.keys(avail).forEach(provider => {
                        (avail[provider] || []).forEach(m => {
                            if (!pricing[m]) pricing[m] = pricing[m] || { input_per_1k: '', output_per_1k: '' };
                        });
                    });
                }
            } catch (e) {
                // ignore
            }

            // Ensure the current translation model is present
            try {
                const currentModel = window.chapterData && window.chapterData.translationModel;
                if (currentModel && !pricing[currentModel]) pricing[currentModel] = { input_per_1k: '', output_per_1k: '' };
            } catch (e) {}

            Object.keys(pricing).forEach(model => {
                const p = pricing[model] || {};
                list.appendChild(createValueRow(model, p.input_per_1k || '', p.output_per_1k || ''));
            });

            document.getElementById('values-modal').style.display = 'flex';
        })();
    }

    function closeValuesModal() {
        document.getElementById('values-modal').style.display = 'none';
    }

    document.getElementById('values-btn').addEventListener('click', openValuesModal);
    document.getElementById('close-values-modal').addEventListener('click', closeValuesModal);
    document.getElementById('cancel-values-btn').addEventListener('click', closeValuesModal);

    document.getElementById('add-value-row').addEventListener('click', () => {
        const list = document.getElementById('values-list');
        list.appendChild(createValueRow('', '', ''));
    });

    document.getElementById('save-values-btn').addEventListener('click', () => {
        const rows = Array.from(document.querySelectorAll('#values-list .value-row'));
        const obj = {};
        rows.forEach(r => {
            const model = r.querySelector('.value-model').value.trim();
            const input = r.querySelector('.value-input').value.trim();
            const output = r.querySelector('.value-output').value.trim();
            if (model) {
                obj[model] = { input_per_1k: input || '0', output_per_1k: output || '0' };
            }
        });
        (async function () {
            try {
                await fetch('/api/pricing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(obj)
                });
            } catch (e) {
                console.warn('Error saving pricing to server', e);
            }

            try {
                localStorage.setItem('lf_model_pricing', JSON.stringify(obj));
            } catch (e) {
                console.warn('Error saving pricing locally', e);
            }

            closeValuesModal();
            // Reload the dashboard to reflect pricing
            loadTokenUsageStats();
        })();
    });
</script>
{% endblock %}

