{% extends "base.html" %}

{% block title %}
{% if chapter_index is not none %}
{{ chapter.get('translated_title', chapter.title) }} - Chapter Settings
{% else %}
{{ get_display_title(novel) }} - Novel Settings
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <header>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            {% if chapter_index is not none %}
            <a href="/chapter/{{ novel_id }}/{{ chapter_index }}" class="btn btn-primary">‚Üê Back to Chapter</a>
            {% else %}
            <a href="/novel/{{ novel_id }}" class="btn btn-primary">‚Üê Back to Novel</a>
            {% endif %}
            {% if novel.get('novel_source_url') %}
            <a href="{{ novel.novel_source_url }}" target="_blank" class="btn btn-secondary">üîó View on Novelpia</a>
            {% endif %}
        </div>
        {% if chapter_index is not none %}
        <h1>{{ chapter.get('translated_title', chapter.title) }}</h1>
        <p class="subtitle">Chapter Settings</p>
        {% else %}
        <h1>{{ get_display_title(novel) }}</h1>
        <p class="subtitle">Novel Settings</p>
        {% endif %}
    </header>

    <div id="alert-container"></div>

    {% if chapter_index is not none %}
    <div class="settings-card">
        <h2>üóëÔ∏è Chapter Management</h2>
        <p style="color: #718096; margin-bottom: 15px;">
            Delete Chapter {{ chapter_index + 1 }}:
            <strong>{{ chapter.get('translated_title', chapter.title) }}</strong>
            {% if chapter.get('translated_title') and chapter.get('translated_title') != chapter.title %}
            <br><em style="font-size: 0.9rem; color: #a0aec0;">ÏõêÏ†ú: {{ chapter.title }}</em>
            {% endif %}
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/chapter/{{ novel_id }}/{{ chapter_index }}?edit=true" class="btn btn-warning"
                style="padding: 12px 24px;">
                ‚úèÔ∏è Edit Chapter Content
            </a>
            <button id="delete-chapter-btn" class="btn btn-danger" style="padding: 12px 24px;"
                data-delete-type="chapter">
                üóëÔ∏è Delete This Chapter
            </button>
        </div>
    </div>
    {% endif %}

    {% if chapter_index is none %}
    <div class="settings-card">
        <h2>üì• Export Novel</h2>
        <p style="color: #718096; margin-bottom: 15px;">
            Download the entire novel as PDF or EPUB.
        </p>
        <a href="/api/export/{{ novel_id }}/pdf" class="btn btn-export" download>üìÑ Download as PDF</a>
        <a href="/api/export/{{ novel_id }}/epub" class="btn btn-export" download>üìñ Download as EPUB</a>
    </div>
    {% endif %}

    {% if show_delete_novel %}
    <div class="settings-card">
        <h2>‚ö†Ô∏è Danger Zone</h2>
        <div class="alert alert-warning" style="margin-bottom: 15px;">
            <strong>Warning:</strong> Deleting this novel will permanently remove all chapters, translations, and
            character glossary. This action cannot be undone.
        </div>
        <button id="delete-novel-btn" class="btn btn-danger" style="padding: 12px 24px;" data-delete-type="novel">
            üóëÔ∏è Delete Entire Novel
        </button>
    </div>
    {% endif %}

    <div class="settings-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>üìù Character Glossary</h2>
        </div>

        <div class="button-group">
            <button id="add-character-btn" class="btn btn-success">‚ûï Add Character Manually</button>
            <button id="auto-detect-btn" class="btn btn-warning">ü§ñ Auto-Detect Characters</button>
        </div>

        <div class="alert alert-info">
            üí° <strong>Tip:</strong> Use "Auto-Detect Characters" to let the AI find character names in your chapters
            automatically and translate them to English. Click on any character to expand and edit details.
        </div>

        <div id="characters-container">
            {% if glossary %}
            {% for char_id, char_info in glossary.items() %}
            <div class="character-entry collapsed" data-char-id="{{ char_id }}">
                <div class="character-header">
                    <div class="character-summary">
                        <span class="korean-name">{{ char_info.get('korean_name', '') }}</span>
                        <span class="arrow">‚Üí</span>
                        <span class="english-name">{{ char_info.get('english_name', '(Not set)') }}</span>
                        {% if char_info.get('gender') %}
                        <span class="gender-badge gender-{{ char_info.get('gender') }}">{{ char_info.get('gender')
                            }}</span>
                        {% else %}
                        <span class="gender-badge gender-none">not set</span>
                        {% endif %}
                    </div>
                    <div class="character-actions">
                        <button class="btn btn-danger btn-remove-char">‚úï</button>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>
                <div class="character-details">
                    <div class="form-group">
                        <label>Korean Name (Original)</label>
                        <input type="text" class="char-korean" placeholder="e.g., ÍπÄÏ≤†Ïàò"
                            value="{{ char_info.get('korean_name', '')|e }}">
                    </div>

                    <div class="form-group">
                        <label>English Name (Translation)</label>
                        <input type="text" class="char-english" placeholder="e.g., John Kim"
                            value="{{ char_info.get('english_name', '')|e }}">
                    </div>

                    <div class="form-group">
                        <label>Gender</label>
                        <select class="char-gender">
                            <option value="">Not specified</option>
                            <option value="male" {% if char_info.get('gender')=='male' %}selected{% endif %}>Male
                                (he/him)</option>
                            <option value="female" {% if char_info.get('gender')=='female' %}selected{% endif %}>Female
                                (she/her)</option>
                            <option value="other" {% if char_info.get('gender')=='other' %}selected{% endif %}>Other
                                (they/them)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Character Notes</label>
                        <textarea class="char-description"
                            placeholder="e.g., Main protagonist, skilled swordsman, age 25">{{ char_info.get('description', '') }}</textarea>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p id="empty-message" style="text-align: center; color: #718096; padding: 40px;">
                No characters added yet. Click "Add Character Manually" or "Auto-Detect Characters" to get started.
            </p>
            {% endif %}
        </div>
    </div>

    <div style="text-align: center;">
        <button id="save-settings-btn" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 40px;">
            üíæ Save Character Glossary
        </button>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <h2 style="color: #2d3748; margin-bottom: 10px;">ü§ñ Auto-Detecting Characters...</h2>
        <p style="color: #718096;">Analyzing chapters and translating names...</p>
        <div class="spinner"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DEBUG: novel_id = {{ novel_id }}, chapters = {{ novel.get('chapters', [])|length if novel else 'NO NOVEL' }} -->
<script>
    // Set novelSettingsData directly - DEBUG
    console.log('Setting up novelSettingsData...');
    window.novelSettingsData = {
        novelId: "{{ novel_id }}",
        chapterIndex: {% if chapter_index is not none %}{{ chapter_index }}{% else %}null{% endif %},
        glossaryLength: {{ glossary|length if glossary else 0 }},
        chapterText: "",
        totalChapters: {{ novel.get('chapters', [])|length if novel else 0 }}
    };
    console.log('novelSettingsData set to:', window.novelSettingsData);
</script>
<script src="{{ url_for('static', filename='js/novel_settings.js') }}"></script>

<script>
    (function () {
        let deleteInProgress = false;

        // Safety check - log but don't block if data exists
        if (!window.novelSettingsData) {
            console.error('novelSettingsData not defined');
            window.novelSettingsData = { novelId: '', chapterIndex: null, glossaryLength: 0, chapterText: '', totalChapters: 0 };
        }

        function handleDeleteClick(e) {
            // Check novelId at click time
            if (!window.novelSettingsData.novelId) {
                alert('Error: Novel ID not found. Please refresh the page and try again.');
                return;
            }
            e.preventDefault();
            e.stopPropagation();

            // Prevent double clicks
            if (deleteInProgress) return;
            deleteInProgress = true;

            let deleteType = e.target.dataset.deleteType;
            let confirmMessage = '';

            // Check if this is the last chapter
            if (deleteType === 'chapter' && window.novelSettingsData.totalChapters === 1) {
                confirmMessage = '‚ö†Ô∏è This is the last chapter in the novel.\n\nDeleting it will also delete the entire novel, including all translations and character glossary.\n\nAre you sure you want to proceed?';

                if (!confirm(confirmMessage)) {
                    deleteInProgress = false;
                    return;
                }

                // Switch to novel deletion
                deleteType = 'novel';
                performDelete(deleteType);
            } else {
                if (deleteType === 'chapter') {
                    confirmMessage = 'Are you sure you want to delete this chapter? This action cannot be undone.';
                } else if (deleteType === 'novel') {
                    confirmMessage = 'Are you sure you want to delete this entire novel?\n\nThis will permanently remove all chapters, translations, and character glossary.\n\nThis action cannot be undone!';
                }

                // Only ask once
                if (!confirm(confirmMessage)) {
                    deleteInProgress = false;
                    return;
                }

                performDelete(deleteType);
            }
        }

        async function performDelete(deleteType) {
            try {
                let endpoint = '';
                let payload = {};

                if (deleteType === 'chapter') {
                    endpoint = '/api/delete-chapter';
                    payload = {
                        novel_id: window.novelSettingsData.novelId,
                        chapter_index: window.novelSettingsData.chapterIndex
                    };
                } else if (deleteType === 'novel') {
                    endpoint = '/api/delete-novel';
                    payload = {
                        novel_id: window.novelSettingsData.novelId
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    if (deleteType === 'chapter') {
                        showAlert('‚úì Chapter deleted successfully! Redirecting...', 'success');
                        setTimeout(function () {
                            window.location.href = '/novel/' + encodeURIComponent(window.novelSettingsData.novelId);
                        }, 1500);
                    } else {
                        showAlert('‚úì Novel deleted successfully! Redirecting...', 'success');
                        setTimeout(function () {
                            window.location.href = '/';
                        }, 1500);
                    }
                } else {
                    showAlert('‚ùå Error: ' + data.error, 'error');
                    deleteInProgress = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå An error occurred while deleting.', 'error');
                deleteInProgress = false;
            }
        }

        // Attach event listeners
        const deleteChapterBtn = document.getElementById('delete-chapter-btn');
        const deleteNovelBtn = document.getElementById('delete-novel-btn');

        if (deleteChapterBtn) {
            deleteChapterBtn.addEventListener('click', handleDeleteClick);
        }

        if (deleteNovelBtn) {
            deleteNovelBtn.addEventListener('click', handleDeleteClick);
        }
    })();

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
        alertDiv.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
    }
</script>
{% endblock %}